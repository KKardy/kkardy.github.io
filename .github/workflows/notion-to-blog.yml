name: Notion to Blog

on:
  workflow_dispatch:
    inputs:
      notion_page_id:
        description: 'Notion Page ID'
        required: true
  schedule:
    - cron: '0 0 * * *'  # 매일 자정에 실행

jobs:
  notion-to-blog:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'
    
    - name: Install Dependencies
      run: |
        npm init -y
        npm install @notionhq/client notion-to-md axios
    
    - name: Convert Notion to Blog Post
      env:
        NOTION_SECRET: ${{ secrets.NOTION_SECRET }}
        NOTION_PAGE_ID: ${{ github.event.inputs.notion_page_id || '' }}
      run: |
        cat > notion-to-blog.js << EOL
        const {Client} = require("@notionhq/client");
        const {NotionToMarkdown} = require("notion-to-md");
        const fs = require("fs");
        const path = require("path");
        const axios = require("axios");

        const notion = new Client({ auth: process.env.NOTION_SECRET });
        const n2m = new NotionToMarkdown({ notionClient: notion });

        async function convertNotionToBlogPost(pageId) {
          try {
            const mdblocks = await n2m.pageToMarkdown(pageId);
            const page = await notion.pages.retrieve({ page_id: pageId });
            const title = page.properties.title.title[0].plain_text;

            let mdString = n2m.toMarkdownString(mdblocks);
            mdString.parent = mdString.parent.replace(/\n\n/g, "\n");

            const date = new Date().toISOString().split('T')[0].replace(/-/g, '-');
            const filename = \`\${date}-\${title.replace(/[^a-z0-9]/gi, '-').toLowerCase()}.md\`;
            const filepath = path.join(process.cwd(), 'posts', filename);

            fs.writeFileSync(filepath, \`---
title: "\${title}"
date: \${date}
---

\${mdString.parent}\`);

            console.log(\`Blog post created: \${filename}\`);
          } catch (error) {
            console.error('Error converting Notion page:', error);
            process.exit(1);
          }
        }

        convertNotionToBlogPost(process.env.NOTION_PAGE_ID);
        EOL

        node notion-to-blog.js

    - name: Commit and Push
      run: |
        git config user.name "GitHub Actions"
        git config user.email "<>"
        git add posts
        git commit -m "Add blog post from Notion" || exit 0
        git push